-- sample data with BETOS and AAPC mappings + PAL
with sample_data as (
SELECT a.*
-- , c.pal as Excellus_PAL
, a.pal_category as PAL_mapping
, b.short_description as AAPC_short_desc
, b.section1 as AAPC_section1
, b.section2 as AAPC_section2
, d.rbcs_id
, d.rbcs_cat_desc
, d.rbcs_subcat_desc
, d.rbcs_family_desc
, d.rbcs_major_ind
, (case when a.dsc_with_hierarchy in ('Home Health', 'SNF') then a.dsc_with_hierarchy else 'Non PACT' end )as PACT_FLAG
FROM "testdb"."vt_sample_claimants_75kmbrs_add_utilcounting" a
left join "reference_library"."aapc_cpt_hcpcs_grouping" b
on a.procedure_code = b.code
-- left join testdb.vt_sample_excellusPAL  c

left join "testdb"."servicemapping_betos" d
on a.procedure_code = d.procedure_code
order by a.member_ssn, a.service_from_date),


triggers_plus_shells as (
select * from  "testdb"."vt_sample_claimants_75kmbrs_Enc_TriggerShells" ),


/******************************* Assignment**************************/
-- select primary triggers
-- primary triggers - still need one more level of deduping after this to get rid of encoutner keys in OP billed with same proc code
Primary_triggers as (
select * 
from triggers_plus_shells
where trigger_key_no_hierarchy = trigger_key_primary
order by encounter_key),


-- helper tables
-- relevant primary and secondary Dxs to the primary trigger entries; will determine relevenacy by 1st 3 bytes of the the Dx code
relevant_Dxs as (
  select encounter_key
  , substring(trigger_code_Dx1,1,3) as Dx_group
  from triggers_plus_shells

  UNION ALL
  
  select encounter_key
    , substring(trigger_code_Dx2,1,3) as Dx_group
    from triggers_plus_shells

 ),
 
 relevant_Dx_array as (
select encounter_key
, array_join(array_agg(Dx_group), ',', 'NULL') as relevant_Dx_array
from (
 select * 
 from relevant_Dxs  
 group by 1,2)
 group by encounter_key),


-- Table to help identify records for carve out, if multiple PALs happen within same encounter

carve_out_records as (
select encounter_key
, trigger_key_primary
, unique_key
from Primary_triggers
where rank_PAL_enc_key > 1),


-- add relevant Dxs to primary triggers table
add_relevant_dxs as (
  select a.* 
  , b.relevant_Dx_array
  from Primary_triggers a
  left join relevant_Dx_array b
  on a.encounter_key = b.encounter_key),
   
 
-- assignment to M rbcs categories, no carve out
M_assignment_nocarve as (
select a.* 
, (case when a.rank_PAL_enc_key = 1 then sum(b.allowed_amount) 
   else NULL end) as enc_cost_no_carveout
from add_relevant_dxs a
left join sample_data b
on a.member_ssn = b.member_ssn 
and (b.service_from_date between a.shell_start and a.shell_end)
and a.PACT_FLAG = b.PACT_FLAG
where a.rbcs_major_ind = 'M'
  group by 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29),

-- assigment for O rbcs categories, requires same Dx family
O_assignment_nocarve as (
select a.* 
, (case when a.rank_PAL_enc_key = 1 then sum(b.allowed_amount) 
   else NULL end) as enc_cost_no_carveout
from add_relevant_dxs a
left join sample_data b
on a.member_ssn = b.member_ssn 
and (b.service_from_date between a.shell_start and a.shell_end)
and a.PACT_FLAG = b.PACT_FLAG
and a.relevant_Dx_array LIKE  concat('%', trim(substring(b.diagnosis_code1,1,3)) ,'%')
  
where a.rbcs_major_ind = 'O'
    group by 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29),


-- assigment for all others, requires same Dx family & provider TIN
AllOther_assignment_nocarve as (
select a.* 
, (case when a.rank_PAL_enc_key = 1 then sum(b.allowed_amount) 
   else NULL end) as enc_cost_no_carveout
from add_relevant_dxs a
left join sample_data b
on a.member_ssn = b.member_ssn 
and (b.service_from_date between a.shell_start and a.shell_end)
and a.PACT_FLAG = b.PACT_FLAG
and a.relevant_Dx_array LIKE  concat('%', trim(substring(b.diagnosis_code1,1,3)) ,'%')
and a.provider_tin = b.provider_tin
where a.rbcs_major_ind not in( 'O', 'M')
    group by 1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29),


Merge_Tables as
(select * from M_assignment_nocarve

Union ALL 

select * from O_assignment_nocarve

UNION ALL

select * from AllOther_assignment_nocarve),

-- final dedup for procs bill OP under same proc code
dedup_encounters as (
select * from (
select a.*
, row_number() over (partition by encounter_key, enc_cost_no_carveout, rank_pal_enc_key order by allowed desc) dedup_enc_allowed
from Merge_Tables a)
where dedup_enc_allowed = 1),



/********************* Xwalk from Enc to Claims Table ********************/

-- assignment to M rbcs categories, no carve out
M_assignment_nocarve_Xwalk as (
select a.encounter_key 
, (case when a.rank_PAL_enc_key = 1 then b.unique_key
   else NULL end) as unique_key_xwalk
from add_relevant_dxs a
left join sample_data b
on a.member_ssn = b.member_ssn 
and (b.service_from_date between a.shell_start and a.shell_end)
and a.PACT_FLAG = b.PACT_FLAG
where a.rbcs_major_ind = 'M'
  group by 1,2),

-- assigment for O rbcs categories, requires same Dx family
O_assignment_nocarve_Xwalk as (
select a.encounter_key  
, (case when a.rank_PAL_enc_key = 1 then b.unique_key
   else NULL end) as unique_key_xwalk
from add_relevant_dxs a
left join sample_data b
on a.member_ssn = b.member_ssn 
and (b.service_from_date between a.shell_start and a.shell_end)
and a.PACT_FLAG = b.PACT_FLAG
and a.relevant_Dx_array LIKE  concat('%', trim(substring(b.diagnosis_code1,1,3)) ,'%')
  
where a.rbcs_major_ind = 'O'
    group by 1,2),


-- assigment for all others, requires same Dx family & provider TIN
AllOther_assignment_nocarve_Xwalk as (
select a.encounter_key 
, (case when a.rank_PAL_enc_key = 1 then b.unique_key
   else NULL end) as unique_key_xwalk
from add_relevant_dxs a
left join sample_data b
on a.member_ssn = b.member_ssn 
and (b.service_from_date between a.shell_start and a.shell_end)
and a.PACT_FLAG = b.PACT_FLAG
and a.relevant_Dx_array LIKE  concat('%', trim(substring(b.diagnosis_code1,1,3)) ,'%')
and a.provider_tin = b.provider_tin
where a.rbcs_major_ind not in( 'O', 'M')
    group by 1,2),

Merge_Xwalk_Tables as
(select * from M_assignment_nocarve_Xwalk

Union ALL 

select * from O_assignment_nocarve_Xwalk

UNION ALL

select * from AllOther_assignment_nocarve_Xwalk),

XWalk_to_Claims as (
select * 
from Merge_Xwalk_Tables 
group by 1,2
order by 1,2)


/********************* Flags ********************/
-- ER
-- HH, SNF %
-- HH, SNF $
-- Readmit rates


/********************* Testing ********************/
select pal_mapping
-- , rbcs_cat_desc
-- , rbcs_subcat_desc
-- , rbcs_family_desc
, pos_type
, asc_indicator
, sum(allowed) as trigger_allowed
, sum (enc_cost_no_carveout) as enc_allowed
, count(*) as enc_count
from dedup_encounters
group by 1,2,3
order by 1,2,3





-- 168526616
-- 317,905 primary triggers before final dedup
-- 317,927
